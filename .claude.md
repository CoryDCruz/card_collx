# Card Collection Tracker - Project Context

## Project Overview

A mobile-first web application for tracking and managing sports card collections. Users can scan cards using their iPhone camera, catalog them, and use AI agents to discover average market prices.

## Goals

1. **Card Scanning**: Use phone camera to capture card images
2. **Cataloging**: Store and organize card collection with metadata
3. **AI Price Discovery**: Use AI agents to find average sell prices from multiple sources
4. **Mobile Experience**: iPhone-optimized with PWA support (future)

## Tech Stack

### Backend
- **FastAPI** - Python web framework
- **SQLAlchemy** - ORM for database operations
- **Pydantic** - Data validation and settings
- **SQLite** - Database (can upgrade to PostgreSQL)
- **Python 3.8+**

### Frontend
- **React** - UI framework
- **TypeScript** - Type safety
- **Vite** - Build tool and dev server
- **Axios** - HTTP client
- **Node.js 20+**

### Future Integrations
- **OpenAI Vision API** or **Google Cloud Vision** - Card image recognition
- **LangChain/CrewAI** - AI agents for price discovery
- **Anthropic Claude API** - AI agent intelligence

## Project Structure

```
card_collx/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ api/          # API routes and endpoints
â”‚   â”‚   â”‚   â””â”€â”€ routes.py # Card CRUD, scan, price endpoints
â”‚   â”‚   â”œâ”€â”€ core/         # Configuration and settings
â”‚   â”‚   â”‚   â””â”€â”€ config.py # App settings, CORS, env vars
â”‚   â”‚   â”œâ”€â”€ models/       # Data models
â”‚   â”‚   â”‚   â””â”€â”€ card.py   # Card, CardCreate, CardPrice models
â”‚   â”‚   â”œâ”€â”€ services/     # Business logic
â”‚   â”‚   â”‚   â”œâ”€â”€ storage/  # Storage abstraction layer
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ base.py   # Storage interface
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ local.py  # Local filesystem implementation
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ image_processor.py  # Image validation and processing
â”‚   â”‚   â”‚   â””â”€â”€ image_service.py    # High-level image orchestration
â”‚   â”‚   â””â”€â”€ db/           # Database setup
â”‚   â”‚       â”œâ”€â”€ database.py  # SQLAlchemy setup
â”‚   â”‚       â””â”€â”€ models.py    # ORM models
â”‚   â”œâ”€â”€ uploads/          # Uploaded card images
â”‚   â”œâ”€â”€ requirements.txt  # Python dependencies
â”‚   â””â”€â”€ .env.example      # Environment variables template
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/   # React components
â”‚   â”‚   â”‚   â””â”€â”€ CardScanner.tsx  # Camera/file upload component
â”‚   â”‚   â”œâ”€â”€ pages/        # Page components
â”‚   â”‚   â”‚   â””â”€â”€ Home.tsx  # Main home page
â”‚   â”‚   â”œâ”€â”€ services/     # API client
â”‚   â”‚   â”‚   â””â”€â”€ api.ts    # Axios-based API service
â”‚   â”‚   â””â”€â”€ types/        # TypeScript types
â”‚   â”‚       â””â”€â”€ card.ts   # Card-related types
â”‚   â””â”€â”€ .env.example      # Frontend env template
â””â”€â”€ .claude.md           # This file - project context
```

## Current Implementation Status

### âœ… Completed
- [x] Initial project structure created
- [x] FastAPI backend skeleton with placeholder routes
- [x] React + TypeScript frontend with Vite
- [x] Card data models (Pydantic)
- [x] API routes for cards (GET, POST, scan, price)
- [x] CardScanner component with camera/file upload
- [x] API service layer with Axios
- [x] TypeScript types matching backend models
- [x] Git repository initialized
- [x] Code pushed to GitHub: https://github.com/CoryDCruz/card_collx
- [x] Database models and migrations (SQLAlchemy)
- [x] Image processing and storage system
  - Storage abstraction layer (local filesystem, cloud-ready)
  - Automatic image optimization (resize to 1024x1024 max, JPEG compression)
  - Static file serving via FastAPI
  - Organized storage structure: `uploads/{card_id}/{filename}`
  - Automatic cleanup on card deletion

### ðŸš§ Not Yet Implemented
- [ ] Card recognition/OCR functionality
- [ ] AI agent for price discovery
- [ ] User authentication
- [ ] PWA features (offline support, installable)
- [ ] Card search and filtering
- [ ] Price history tracking

## API Endpoints

### Operational
- `GET /` - API info
- `GET /health` - Health check
- `GET /api/cards` - Get all cards
- `POST /api/cards` - Create a card manually
- `POST /api/cards/scan` - Upload and scan a card image (fully implemented)
- `GET /api/cards/{id}` - Get a specific card
- `PUT /api/cards/{id}` - Update a card
- `DELETE /api/cards/{id}` - Delete a card (with automatic image cleanup)
- `GET /uploads/{card_id}/{filename}` - Serve uploaded card images

### Placeholder (need implementation)
- `GET /api/cards/{id}/price` - Get price info for a card (AI agent integration needed)

## Data Models

### Card
```python
{
  "id": int,
  "player_name": str,
  "year": Optional[int],
  "brand": Optional[str],
  "card_number": Optional[str],
  "set_name": Optional[str],
  "sport": Optional[str],
  "condition": Optional[str],
  "notes": Optional[str],
  "image_url": Optional[str],
  "created_at": datetime,
  "updated_at": datetime
}
```

## Development Setup

### Backend
```bash
cd backend
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
pip install -r requirements.txt
cp .env.example .env
uvicorn app.main:app --reload
```
API available at: http://localhost:8000
Docs at: http://localhost:8000/docs

### Frontend
```bash
cd frontend
npm install
cp .env.example .env
npm run dev
```
App available at: http://localhost:5173

## Environment Variables

### Backend (.env)
- `DATABASE_URL` - Database connection string
- `UPLOAD_DIR` - Directory for uploaded images
- `OPENAI_API_KEY` - For image recognition (future)
- `ALLOWED_ORIGINS` - CORS origins

### Frontend (.env)
- `VITE_API_URL` - Backend API URL (default: http://localhost:8000/api)

## Next Steps Priority

1. **Card Recognition** - Integrate OCR or vision API for card identification
   - Use OpenAI Vision API or Google Cloud Vision to extract player name, year, brand, etc.
   - Auto-populate card metadata from scanned images
2. **AI Price Agent** - Build LangChain/CrewAI agent for price discovery
   - Query multiple sources (eBay, COMC, PSA, etc.)
   - Calculate average market value
3. **Frontend Integration** - Connect CardScanner to new backend
   - Test image upload from mobile device
   - Display uploaded images in UI
4. **PWA Features** - Add service worker and manifest for mobile app experience
   - Offline support
   - Installable on iOS home screen

## Important Notes

- **Mobile-First**: All UI should work well on iPhone Safari
- **Camera Access**: Use `capture="environment"` for rear camera on mobile
- **CORS**: Already configured for localhost:5173 and localhost:3000
- **Git**: Repository at https://github.com/CoryDCruz/card_collx
- **Git Commits**: Do NOT include Claude Code attribution or co-authored-by messages in commits
- **Node Version**: Current 20.12.1 (works but shows warnings, consider upgrading to 20.19+)

## Conventions

- Backend uses snake_case for Python
- Frontend uses camelCase for TypeScript/JavaScript
- All API responses use snake_case (matches backend)
- Type definitions mirror backend Pydantic models
- Use async/await for all API calls
- TODOs marked in code for future implementation

## Image Processing Details

### Storage Architecture
- **Abstract Interface**: `StorageBackend` allows easy migration to S3/Azure/GCP
- **Local Implementation**: Files stored in `uploads/{card_id}/{filename}`
- **Async I/O**: Uses `aiofiles` for non-blocking file operations

### Image Processing Pipeline
1. **Validation**: File type, size (10MB max), and integrity checks
2. **Optimization**: Resize to max 1024x1024 pixels (aspect ratio preserved)
3. **Compression**: Convert to JPEG at 85% quality
4. **Filename Generation**: `{timestamp}_{hash}_{sanitized_name}.jpg` for uniqueness
5. **Storage**: Save to organized directory structure
6. **Database**: Update card record with `image_url` field

### Error Handling
- Invalid files rejected with clear error messages (400 Bad Request)
- Files too large rejected (413 Payload Too Large)
- Automatic cleanup of orphaned database records if image processing fails
- Image deletion cascades when card is deleted

---

**Last Updated**: Image processing implementation - 2025-12-07
**Status**: Full image upload, processing, storage, and serving operational. Ready for card recognition integration.
